# ============================================
# YAML Anchors (DRY Principle)
# ============================================
x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

x-healthcheck-defaults: &healthcheck-defaults
  interval: 5s
  timeout: 3s
  retries: 4
  start_period: 3s

# Resource limits for production stability
x-resource-limits: &resource-limits
  deploy:
    resources:
      limits:
        memory: ${CONTAINER_MEMORY_LIMIT:-512M}
      reservations:
        memory: 128M

x-security-opts: &security-opts
  security_opt:
    - no-new-privileges:true
  read_only: false

x-varnish-common: &varnish-common
  image: varnish:stable
  restart: unless-stopped
  stop_grace_period: 30s
  tmpfs:
    - /var/lib/varnish:exec
  environment:
    VARNISH_SIZE: ${VARNISH_CACHE_SIZE:-128M}
  networks:
    frontend:
      aliases:
        - varnish
    backend:
      aliases:
        - varnish
  healthcheck:
    test: ["CMD-SHELL", "varnishadm vcl.list || exit 1"]
    <<: *healthcheck-defaults
    interval: 5s
    start_period: 3s
  logging: *default-logging

x-nginx-common: &nginx-common
  build:
    context: ./bin/nginx
  restart: unless-stopped
  ports:
    - "${HOST_MACHINE_UNSECURE_HOST_PORT:-80}:80"
    - "${HOST_MACHINE_SECURE_HOST_PORT:-443}:443"
  volumes:
    - "${NGINX_CONF_DIR}:/etc/nginx/extra-conf.d:ro"
    - "./config/nginx/partials:/etc/nginx/partials:ro"
    - "${DOCUMENT_ROOT}:/var/www/html:ro"
    - "${SSL_DIR}:/etc/nginx/ssl-sites:rw"
    - "${NGINX_LOG_DIR}:/var/log/nginx"
  environment:
    APACHE_DOCUMENT_ROOT: "${APACHE_DOCUMENT_ROOT}"
    APPLICATIONS_DIR_NAME: "${APPLICATIONS_DIR_NAME}"
    APP_ENV: "${APP_ENV:-development}"
  networks:
    frontend:
      aliases:
        - reverse-proxy
    backend:
      aliases:
        - reverse-proxy
  healthcheck:
    test: ["CMD", "curl", "-sf", "http://localhost/nginx-health"]
    <<: *healthcheck-defaults
    timeout: 3s
    start_period: 3s
    interval: 5s
  logging: *default-logging

x-webserver-common: &webserver-common
  restart: unless-stopped
  volumes:
    - "${DOCUMENT_ROOT}:${APACHE_DOCUMENT_ROOT}:rw"
    - "./config/php/php.${APP_ENV:-development}.ini:/usr/local/etc/php/php.ini:ro"
    - "${BACKUP_DIR}:/var/lib/bkup/dumps"
  environment:
    APACHE_DOCUMENT_ROOT: "${APACHE_DOCUMENT_ROOT}"
    APP_ENV: "${APP_ENV:-development}"
    APP_DEBUG: "${APP_DEBUG:-true}"
    # Database
    DB_HOST: "dbhost"
    MYSQL_DATABASE: "${MYSQL_DATABASE}"
    MYSQL_USER: "${MYSQL_USER}"
    MYSQL_PASSWORD: "${MYSQL_PASSWORD}"
    # Redis
    REDIS_HOST: "redis"
    REDIS_PASSWORD: "${REDIS_PASSWORD:-}"
  depends_on:
    dbhost:
      condition: service_healthy
    redis:
      condition: service_healthy
  networks:
    backend:
      aliases:
        - webserver
    frontend:
      aliases:
        - webserver
  logging: *default-logging

services:
  # ============================================
  # Reverse Proxy (NGINX) - Hybrid Mode
  # ============================================
  reverse-proxy:
    <<: *nginx-common
    container_name: "${COMPOSE_PROJECT_NAME}-nginx"
    profiles:
      - hybrid
    volumes:
      - "./config/nginx/modes/hybrid.conf.template:/etc/nginx/templates/00-default.conf.template:ro"
      - "${NGINX_CONF_DIR}:/etc/nginx/extra-conf.d:ro"
      - "./config/nginx/partials:/etc/nginx/partials:ro"
      - "${DOCUMENT_ROOT}:/var/www/html:ro"
      - "${SSL_DIR}:/etc/nginx/ssl-sites:rw"
      - "${NGINX_LOG_DIR}:/var/log/nginx"
    environment:
      APACHE_DOCUMENT_ROOT: "${APACHE_DOCUMENT_ROOT}"
      APPLICATIONS_DIR_NAME: "${APPLICATIONS_DIR_NAME}"
      APP_ENV: "${APP_ENV:-development}"
      STACK_MODE: "hybrid"
    depends_on:
      varnish:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost/nginx-health"]
      <<: *healthcheck-defaults
      timeout: 3s
      start_period: 3s
      interval: 5s
    logging: *default-logging

  # ============================================
  # Reverse Proxy (NGINX) - Thunder Mode
  # ============================================
  reverse-proxy-thunder:
    <<: *nginx-common
    container_name: "${COMPOSE_PROJECT_NAME}-nginx-thunder"
    profiles:
      - thunder
    volumes:
      - "./config/nginx/modes/thunder.conf.template:/etc/nginx/templates/00-default.conf.template:ro"
      - "${NGINX_CONF_DIR}:/etc/nginx/extra-conf.d:ro"
      - "./config/nginx/partials:/etc/nginx/partials:ro"
      - "${DOCUMENT_ROOT}:/var/www/html:ro"
      - "${SSL_DIR}:/etc/nginx/ssl-sites:rw"
      - "${NGINX_LOG_DIR}:/var/log/nginx"
    environment:
      APACHE_DOCUMENT_ROOT: "${APACHE_DOCUMENT_ROOT}"
      APPLICATIONS_DIR_NAME: "${APPLICATIONS_DIR_NAME}"
      APP_ENV: "${APP_ENV:-development}"
      STACK_MODE: "thunder"
    depends_on:
      varnish-thunder:
        condition: service_started

  # ============================================
  # Certbot (SSL Generation)
  # ============================================
  certbot:
    image: certbot/certbot
    volumes:
      - "${DOCUMENT_ROOT}:/var/www/html:rw"
      - "./data/certbot/www:/var/www/certbot:rw"
      - "./data/certbot/conf:/etc/letsencrypt:rw"
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
    profiles:
      - tools

  # ============================================
  # PHP-Apache Webserver (Hybrid Mode)
  # ============================================
  webserver-apache:
    <<: *webserver-common
    profiles:
      - hybrid
    build:
      context: ./bin/${PHPVERSION}
      args:
        INSTALL_XDEBUG: "${INSTALL_XDEBUG:-false}"
    container_name: "${COMPOSE_PROJECT_NAME}-php-apache"
    volumes:
      - "${DOCUMENT_ROOT}:${APACHE_DOCUMENT_ROOT}:rw"
      - "${VHOSTS_DIR}:/etc/apache2/custom-sites:rw"
      - "./config/vhosts/include-custom.conf:/etc/apache2/conf-enabled/custom-sites.conf:ro"
      - "./config/vhosts/default.conf:/etc/apache2/sites-enabled/000-default.conf:ro"
      - "./config/vhosts/partials:/etc/apache2/sites-enabled/partials:ro"
      - "./config/php/php.${APP_ENV:-development}.ini:/usr/local/etc/php/php.ini:ro"
      - "./config/php/supervisord.conf:/etc/supervisor/supervisord.conf:ro"
      - "./sites/cron:/etc/cron.d:ro"
      - "./sites/supervisor:/etc/supervisor/conf.d:ro"
      - "${APACHE_LOG_DIR}:/var/log/apache2"
      - "${SSL_DIR}:/etc/apache2/ssl-sites:rw"
      - "${BACKUP_DIR}:/var/lib/bkup/dumps"
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost/ -o /dev/null || exit 1"]
      <<: *healthcheck-defaults
      start_period: 5s
      interval: 5s
      retries: 5

  # ============================================
  # PHP-FPM Webserver (Thunder Mode)
  # ============================================
  webserver-fpm:
    <<: *webserver-common
    profiles:
      - thunder
    build:
      context: ./bin/${PHPVERSION}
      dockerfile: Dockerfile.fpm
      args:
        INSTALL_XDEBUG: "${INSTALL_XDEBUG:-false}"
    container_name: "${COMPOSE_PROJECT_NAME}-php-fpm"
    volumes:
      - "${DOCUMENT_ROOT}:${APACHE_DOCUMENT_ROOT}:rw"
      - "./config/php/php.${APP_ENV:-development}.ini:/usr/local/etc/php/php.ini:ro"
      - "./config/php/supervisord.fpm.conf:/etc/supervisor/supervisord.conf:ro"
      - "./sites/cron:/etc/cron.d:ro"
      - "./sites/supervisor:/etc/supervisor/conf.d:ro"
      - "./config/php/www.conf:/usr/local/etc/php-fpm.d/www.conf:ro"
      - "./sites/php/pools:/usr/local/etc/php-fpm.d/pools:ro"
      - "${APACHE_LOG_DIR}:/var/log/php-fpm"
      - "${BACKUP_DIR}:/var/lib/bkup/dumps"
    networks:
      backend:
        aliases:
          - php-fpm
      frontend:
        aliases:
          - php-fpm
    healthcheck:
      test: ["CMD-SHELL", "SCRIPT_NAME=/ping SCRIPT_FILENAME=/ping REQUEST_METHOD=GET cgi-fcgi -bind -connect 127.0.0.1:9000 || exit 1"]
      <<: *healthcheck-defaults
      start_period: 5s
      interval: 5s
      retries: 5

  # ============================================
  # Internal Nginx for Thunder Mode (Varnish Backend)
  # ============================================
  nginx-fpm:
    image: nginx:alpine
    container_name: "${COMPOSE_PROJECT_NAME}-nginx-fpm"
    restart: unless-stopped
    profiles:
      - thunder
    volumes:
      - "${DOCUMENT_ROOT}:${APACHE_DOCUMENT_ROOT}:ro"
      - "./config/nginx/fpm.conf:/etc/nginx/conf.d/default.conf:ro"
    environment:
      APACHE_DOCUMENT_ROOT: "${APACHE_DOCUMENT_ROOT}"
    networks:
      backend:
        aliases:
          - webserver
      frontend:
        aliases:
          - webserver
    depends_on:
      webserver-fpm:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost/nginx-health"]
      <<: *healthcheck-defaults
      timeout: 3s
      start_period: 3s
      interval: 5s
    logging: *default-logging

  # ============================================
  # Database (MariaDB/MySQL)
  # ============================================
  dbhost:
    build:
      context: ./bin/${DATABASE}
    container_name: "${COMPOSE_PROJECT_NAME}-db"
    restart: unless-stopped
    ports:
      - "127.0.0.1:${HOST_MACHINE_MYSQL_PORT:-3306}:3306"
    volumes:
      - "${MYSQL_INITDB_DIR}:/docker-entrypoint-initdb.d:ro"
      - "${MYSQL_DATA_DIR}:/var/lib/mysql"
      - "${MYSQL_LOG_DIR}:/var/log/mysql"
      - "./config/mariadb/my.cnf:/etc/mysql/conf.d/custom.cnf:ro"
      - "./bin/healthcheck.sh:/usr/local/bin/healthcheck.sh:ro"
    environment:
      MYSQL_ROOT_PASSWORD: "${MYSQL_ROOT_PASSWORD}"
      MYSQL_DATABASE: "${MYSQL_DATABASE}"
      MYSQL_USER: "${MYSQL_USER}"
      MYSQL_PASSWORD: "${MYSQL_PASSWORD}"
    networks:
      - backend
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      <<: *healthcheck-defaults
      start_period: 5s
      interval: 5s
      retries: 6
    logging: *default-logging

  # ============================================
  # Redis Cache
  # ============================================
  redis:
    image: redis:7-alpine
    container_name: "${COMPOSE_PROJECT_NAME}-redis"
    restart: unless-stopped
    ports:
      - "127.0.0.1:${HOST_MACHINE_REDIS_PORT:-6379}:6379"
    volumes:
      - "${REDIS_DATA_DIR}:/data"
    command: >
      redis-server
      --appendonly yes
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --tcp-keepalive 300
      --timeout 0
      --requirepass ${REDIS_PASSWORD:-}
    environment:
      REDIS_PASSWORD: "${REDIS_PASSWORD:-}"
    networks:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "redis-cli ${REDIS_PASSWORD:+-a $REDIS_PASSWORD} ping | grep -q PONG"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 3s
    logging: *default-logging

  # ============================================
  # Mailpit (Development Only)
  # ============================================
  mailpit:
    image: axllent/mailpit:latest
    container_name: "${COMPOSE_PROJECT_NAME}-mailpit"
    restart: unless-stopped
    ports:
      - "127.0.0.1:8025:8025"
      - "127.0.0.1:1025:1025"
    networks:
      - backend
    profiles:
      - development
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8025/"]
      <<: *healthcheck-defaults
      timeout: 3s
      start_period: 3s
      interval: 5s
    logging: *default-logging

  # ============================================
  # phpMyAdmin (Development Only)
  # ============================================
  phpmyadmin:
    image: phpmyadmin:latest
    container_name: "${COMPOSE_PROJECT_NAME}-pma"
    restart: unless-stopped
    ports:
      - "127.0.0.1:${HOST_MACHINE_PMA_PORT:-8080}:80"
    environment:
      PMA_HOST: dbhost
      PMA_PORT: 3306
      PMA_USER: root
      PMA_PASSWORD: "${MYSQL_ROOT_PASSWORD}"
      UPLOAD_LIMIT: "${UPLOAD_LIMIT:-512M}"
      MEMORY_LIMIT: "${MEMORY_LIMIT:-512M}"
      MAX_EXECUTION_TIME: 600
    depends_on:
      dbhost:
        condition: service_healthy
    networks:
      - backend
    profiles:
      - development
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost/"]
      <<: *healthcheck-defaults
      timeout: 5s
      start_period: 5s
      interval: 5s
    logging: *default-logging

  # ============================================
  # Memcached
  # ============================================
  memcached:
    image: memcached:alpine
    container_name: "${COMPOSE_PROJECT_NAME}-memcached"
    restart: unless-stopped
    ports:
      - "127.0.0.1:11211:11211"
    command: memcached -m ${MEMCACHED_MEMORY:-64}
    networks:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "echo stats | nc localhost 11211 | grep -q pid"]
      <<: *healthcheck-defaults
      timeout: 3s
      start_period: 3s
      interval: 5s
    logging: *default-logging

  # ============================================
  # Varnish Cache (Hybrid Mode)
  # ============================================
  varnish:
    <<: *varnish-common
    container_name: "${COMPOSE_PROJECT_NAME}-varnish"
    profiles:
      - hybrid
    volumes:
      - "./config/varnish/hybrid.vcl:/etc/varnish/default.vcl:ro"
    depends_on:
      webserver-apache:
        condition: service_started

  # ============================================
  # Varnish Cache (Thunder Mode)
  # ============================================
  varnish-thunder:
    <<: *varnish-common
    container_name: "${COMPOSE_PROJECT_NAME}-varnish-thunder"
    profiles:
      - thunder
    volumes:
      - "./config/varnish/thunder.vcl:/etc/varnish/default.vcl:ro"
    depends_on:
      nginx-fpm:
        condition: service_started

  # ============================================
  # SSH Server (Per-App SSH/SFTP Access)
  # ============================================
  ssh:
    build:
      context: ./bin/ssh
    container_name: "${COMPOSE_PROJECT_NAME}-ssh"
    restart: unless-stopped
    ports:
      - "${HOST_MACHINE_SSH_PORT:-2244}:22"
    volumes:
      - "${DOCUMENT_ROOT}:/var/www/html:rw"
      - "./sites/ssh:/etc/ssh.d/users:ro"
    environment:
      TBS_ADMIN_USER: "${TBS_ADMIN_USER:-tbsadmin}"
      TBS_ADMIN_PASSWORD: "${TBS_ADMIN_PASSWORD:-tbsadmin123}"
      APPLICATIONS_DIR_NAME: "${APPLICATIONS_DIR_NAME:-applications}"
    networks:
      - backend
    profiles:
      - ssh
    healthcheck:
      test: ["CMD-SHELL", "pgrep sshd || exit 1"]
      <<: *healthcheck-defaults
      timeout: 3s
      start_period: 5s
      interval: 5s
    logging: *default-logging

# ============================================
# Networks
# ============================================
networks:
  frontend:
    driver: bridge
    name: "${COMPOSE_PROJECT_NAME}-frontend"
  backend:
    driver: bridge
    name: "${COMPOSE_PROJECT_NAME}-backend"
