x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "5"

x-webserver-common: &webserver-common
  restart: unless-stopped
  volumes:
    - "${DOCUMENT_ROOT}:${APACHE_DOCUMENT_ROOT}:rw"
    - "./config/php/php.${APP_ENV:-development}.ini:/usr/local/etc/php/php.ini:ro"
    - "${BACKUP_DIR}:/var/lib/bkup/dumps"
  environment:
    APACHE_DOCUMENT_ROOT: "${APACHE_DOCUMENT_ROOT}"
    APP_ENV: "${APP_ENV:-development}"
    APP_DEBUG: "${APP_DEBUG:-true}"
    TZ: "Asia/Kolkata"
  depends_on:
    database:
      condition: service_healthy
    redis:
      condition: service_healthy
  networks:
    backend:
      aliases:
        - webserver
    frontend:
      aliases:
        - webserver
  logging: *default-logging

services:
  # ============================================
  # Reverse Proxy (NGINX)
  # ============================================
  reverse-proxy:
    build:
      context: ./bin/nginx
    container_name: "${COMPOSE_PROJECT_NAME}-nginx"
    restart: unless-stopped
    ports:
      - "${HOST_MACHINE_UNSECURE_HOST_PORT:-80}:80"
      - "${HOST_MACHINE_SECURE_HOST_PORT:-443}:443"
    volumes:
      - "./config/nginx/modes/${STACK_MODE:-hybrid}.conf.template:/etc/nginx/templates/00-default.conf.template:ro"
      - "${NGINX_CONF_DIR}:/etc/nginx/extra-conf.d:ro"
      - "./config/nginx/partials:/etc/nginx/partials:ro"
      - "${DOCUMENT_ROOT}:/var/www/html:ro"
      - "./config/ssl:/etc/nginx/ssl-default:ro"
      - "${SSL_DIR}:/etc/nginx/ssl-sites:ro"
      - "${NGINX_LOG_DIR}:/var/log/nginx"
    environment:
      APACHE_DOCUMENT_ROOT: "${APACHE_DOCUMENT_ROOT}"
      APPLICATIONS_DIR_NAME: "${APPLICATIONS_DIR_NAME}"
      APP_ENV: "${APP_ENV:-development}"
      STACK_MODE: "${STACK_MODE:-hybrid}"
    networks:
      - frontend
      - backend
    depends_on:
      - varnish
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/nginx-health"]
      interval: 30s
      timeout: 5s
      retries: 3
    logging: *default-logging

  # ============================================
  # Certbot (SSL Generation)
  # ============================================
  certbot:
    image: certbot/certbot
    volumes:
      - "${DOCUMENT_ROOT}:/var/www/html:rw"
      - "./sites/ssl:/etc/letsencrypt/live:rw"
      - "./data/certbot/www:/var/www/certbot:rw"
      - "./data/certbot/conf:/etc/letsencrypt:rw"
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"

  # ============================================
  # PHP-Apache Webserver (Hybrid Mode)
  # ============================================
  webserver-apache:
    <<: *webserver-common
    profiles:
      - hybrid
    build:
      context: ./bin/${PHPVERSION}
      args:
        INSTALL_XDEBUG: "${INSTALL_XDEBUG:-false}"
    container_name: "${COMPOSE_PROJECT_NAME}-php-apache"
    volumes:
      - "${DOCUMENT_ROOT}:${APACHE_DOCUMENT_ROOT}:rw"
      - "${VHOSTS_DIR}:/etc/apache2/custom-sites:rw"
      - "./config/vhosts/include-custom.conf:/etc/apache2/conf-enabled/custom-sites.conf:ro"
      - "./config/vhosts/default.conf:/etc/apache2/sites-enabled/000-default.conf:ro"
      - "./config/vhosts/partials:/etc/apache2/sites-enabled/partials:ro"
      - "./config/php/php.${APP_ENV:-development}.ini:/usr/local/etc/php/php.ini:ro"
      - "./config/php/supervisord.conf:/etc/supervisor/supervisord.conf:ro"
      - "${APACHE_LOG_DIR}:/var/log/apache2"
      - "./config/ssl:/etc/apache2/ssl-default:ro"
      - "${SSL_DIR}:/etc/apache2/ssl-sites:ro"
      - "${BACKUP_DIR}:/var/lib/bkup/dumps"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost/ || exit 1"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3

  # ============================================
  # PHP-FPM Webserver (Thunder Mode)
  # ============================================
  webserver-fpm:
    <<: *webserver-common
    profiles:
      - thunder
    build:
      context: ./bin/${PHPVERSION}
      dockerfile: Dockerfile.fpm
      args:
        INSTALL_XDEBUG: "${INSTALL_XDEBUG:-false}"
    container_name: "${COMPOSE_PROJECT_NAME}-php-fpm"
    volumes:
      - "${DOCUMENT_ROOT}:${APACHE_DOCUMENT_ROOT}:rw"
      - "./config/php/php.${APP_ENV:-development}.ini:/usr/local/etc/php/php.ini:ro"
      - "./config/php/supervisord.fpm.conf:/etc/supervisor/supervisord.conf:ro"
      - "./config/php/www.conf:/usr/local/etc/php-fpm.d/www.conf:ro"
      - "${APACHE_LOG_DIR}:/var/log/php-fpm"
      - "${BACKUP_DIR}:/var/lib/bkup/dumps"
    healthcheck:
      test: ["CMD", "cgi-fcgi", "-bind", "-connect", "127.0.0.1:9000"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3

  # ============================================
  # Database (MariaDB/MySQL)
  # ============================================
  database:
    build:
      context: ./bin/${DATABASE}
    container_name: "${COMPOSE_PROJECT_NAME}-db"
    restart: unless-stopped
    ports:
      - "127.0.0.1:${HOST_MACHINE_MYSQL_PORT:-3306}:3306"
    volumes:
      - "${MYSQL_INITDB_DIR}:/docker-entrypoint-initdb.d:ro"
      - "${MYSQL_DATA_DIR}:/var/lib/mysql"
      - "${MYSQL_LOG_DIR}:/var/log/mysql"
      - "./config/mariadb/my.cnf:/etc/mysql/conf.d/custom.cnf:ro"
      - "./bin/healthcheck.sh:/usr/local/bin/healthcheck.sh:ro"
    environment:
      MYSQL_ROOT_PASSWORD: "${MYSQL_ROOT_PASSWORD}"
      MYSQL_DATABASE: "${MYSQL_DATABASE}"
      MYSQL_USER: "${MYSQL_USER}"
      MYSQL_PASSWORD: "${MYSQL_PASSWORD}"
      TZ: "Asia/Kolkata"
    networks:
      - backend
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 5
    logging: *default-logging

  # ============================================
  # Redis Cache
  # ============================================
  redis:
    image: redis:7-alpine
    container_name: "${COMPOSE_PROJECT_NAME}-redis"
    restart: unless-stopped
    ports:
      - "127.0.0.1:${HOST_MACHINE_REDIS_PORT:-6379}:6379"
    volumes:
      - "${REDIS_DATA_DIR}:/data"
    command: >
      redis-server
      --appendonly yes
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --tcp-keepalive 300
      --timeout 0
    networks:
      - backend
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging: *default-logging

  # ============================================
  # Mailpit (Development Only)
  # ============================================
  mailpit:
    image: axllent/mailpit:latest
    container_name: "${COMPOSE_PROJECT_NAME}-mailpit"
    restart: unless-stopped
    ports:
      - "127.0.0.1:8025:8025"
      - "127.0.0.1:1025:1025"
    environment:
      TZ: "Asia/Kolkata"
    networks:
      - backend
    profiles:
      - development
    logging: *default-logging

  # ============================================
  # phpMyAdmin (Development Only)
  # ============================================
  phpmyadmin:
    image: phpmyadmin:latest
    container_name: "${COMPOSE_PROJECT_NAME}-pma"
    restart: unless-stopped
    ports:
      - "127.0.0.1:${HOST_MACHINE_PMA_PORT:-8080}:80"
    environment:
      PMA_HOST: database
      PMA_PORT: 3306
      PMA_USER: root
      PMA_PASSWORD: "${MYSQL_ROOT_PASSWORD}"
      UPLOAD_LIMIT: "${UPLOAD_LIMIT:-512M}"
      MEMORY_LIMIT: "${MEMORY_LIMIT:-512M}"
      MAX_EXECUTION_TIME: 600
    depends_on:
      database:
        condition: service_healthy
    networks:
      - backend
    profiles:
      - development
    logging: *default-logging

  # ============================================
  # Memcached
  # ============================================
  memcached:
    image: memcached:alpine
    container_name: "${COMPOSE_PROJECT_NAME}-memcached"
    restart: unless-stopped
    ports:
      - "127.0.0.1:11211:11211"
    networks:
      - backend
    logging: *default-logging

  # ============================================
  # Varnish Cache
  # ============================================
  varnish:
    image: varnish:stable
    container_name: "${COMPOSE_PROJECT_NAME}-varnish"
    restart: unless-stopped
    volumes:
      - "./config/varnish/${STACK_MODE:-hybrid}.vcl:/etc/varnish/default.vcl:ro"
    tmpfs:
      - /var/lib/varnish:exec
    environment:
      VARNISH_SIZE: 128M
    networks:
      - frontend
      - backend
    healthcheck:
      test: ["CMD-SHELL", "varnishadm ping || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
    logging: *default-logging

# ============================================
# Networks
# ============================================
networks:
  frontend:
    driver: bridge
    name: "${COMPOSE_PROJECT_NAME}-frontend"
  backend:
    driver: bridge
    name: "${COMPOSE_PROJECT_NAME}-backend"
    # internal: true
